# Merchant Financial View - المرحلة 3

## نظرة عامة

لوحة التاجر المالية تتيح للتاجر رؤية المتجر كمنظومة مالية حية، مع إجماليات واضحة وقوائم عملاء مفصلة.

---

## 3.1 Merchant Overview (الإجماليات)

### الإحصائيات المعروضة

| الإحصائية | المصدر | الحساب |
|-----------|--------|--------|
| **عدد العملاء** | `/api/customers` | `COUNT(customers WHERE business_id = X)` |
| **إجمالي الأرصدة** | `/api/ledger/summary` | `SUM(amount) WHERE business_id = X AND status = 'finalized'` |
| **إجمالي الديون** | `/api/ledger/entries` | `SUM(ABS(amount)) WHERE entry_type = 'debt' AND status = 'finalized'` |
| **إجمالي المدفوعات** | `/api/ledger/entries` | `SUM(amount) WHERE entry_type = 'payment' AND status = 'finalized'` |

### حسب العملة

- يتم عرض الإجماليات حسب العملة الأساسية (SAR أولاً)
- يمكن توسيع العرض ليشمل جميع العملات لاحقاً

### التفسير المحاسبي

- **إجمالي الأرصدة**: صافي رصيد جميع العملاء (موجب + سالب)
  - موجب = العملاء لديهم رصيد (التاجر مدين لهم)
  - سالب = العملاء مدينون (التاجر دائن)
- **إجمالي الديون**: مجموع الديون المستحقة على العملاء
- **إجمالي المدفوعات**: مجموع المدفوعات المستلمة من العملاء

---

## 3.2 Customers List (قائمة العملاء المالية)

### البيانات المعروضة لكل عميل

1. **الاسم والهاتف**: من جدول `customers`
2. **الرصيد الحالي**: من `/api/ledger/summary?businessId=X&customerId=Y`
3. **الحالة**:
   - **دائن** (أخضر): رصيد موجب
   - **مدين** (أحمر): رصيد سالب
   - **متعادل** (رمادي): رصيد = 0
4. **زر "كشف الحساب"**: يفتح Customer Ledger View

### الأداء

- يتم جلب رصيد كل عميل بشكل منفصل
- يمكن تحسين الأداء لاحقاً بـ JOIN أو Materialized View

---

## 3.3 Customer Ledger (كشف حساب العميل)

### الميزات

- **Read-Only**: لا تعديل، لا حذف
- **كشف كامل**: جميع `ledger_entries` للعميل
- **تفاصيل واضحة**:
  - المبلغ (موجب/سالب)
  - نوع العملية (payment/debt)
  - الحالة (pending/finalized)
  - التاريخ والوقت
  - المرجع (reference)

### الأمان

- التاجر فقط يمكنه الوصول
- التحقق من الملكية في Backend
- لا يمكن تعديل أو حذف أي قيد

---

## APIs المستخدمة

### `/api/ledger/summary?businessId={id}`
- **بدون `customerId`**: إجمالي جميع العملاء
- **مع `customerId`**: رصيد عميل محدد

### `/api/ledger/entries?businessId={id}`
- **بدون `customerId`**: جميع عمليات المتجر
- **مع `customerId`**: عمليات عميل محدد

### `/api/customers?businessId={id}`
- قائمة العملاء للمتجر

### `/api/business/{id}`
- معلومات المتجر (الاسم، اللوجو)

---

## UX/UI

### الألوان الدلالية

- **أخضر**: رصيد موجب، مدفوعات، دائن
- **أحمر**: رصيد سالب، ديون، مدين
- **رمادي**: متعادل، محايد

### Labels عربية واضحة

- "دائن" بدلاً من "Creditor"
- "مدين" بدلاً من "Debtor"
- "إجمالي الأرصدة" بدلاً من "Total Balances"
- "كشف الحساب" بدلاً من "Statement"

---

## الاختبار

### سيناريو 1: متجر جديد
1. التاجر يفتح `/merchant/{storeId}`
2. **النتيجة المتوقعة**: 
   - عدد العملاء: 0
   - جميع الإجماليات: 0
   - قائمة عملاء فارغة

### سيناريو 2: متجر بعملاء
1. التاجر لديه 5 عملاء
2. 3 عملاء برصيد موجب، 2 برصيد سالب
3. **النتيجة المتوقعة**:
   - عدد العملاء: 5
   - إجمالي الأرصدة: SUM(جميع الأرصدة)
   - قائمة العملاء تعرض الرصيد والحالة لكل عميل

### سيناريو 3: كشف حساب عميل
1. التاجر ينقر على "كشف الحساب" لعميل
2. **النتيجة المتوقعة**:
   - عرض جميع العمليات المالية
   - Read-only (لا أزرار تعديل/حذف)
   - عرض واضح للرصيد الحالي

---

## الملفات المُنشأة/المُعدلة

1. `src/app/components/merchant/MerchantDashboard.tsx` - إعادة كتابة كاملة
2. `src/app/components/merchant/CustomerProfile.tsx` - إعادة كتابة كاملة (read-only)
3. `api/customers/index.ts` - إصلاح لاستخدام `internalUserId`

---

**Document Version**: 1.0  
**Last Updated**: 2026-01-20  
**Status**: ✅ Completed
