# Wallet Domain Clarification - المرحلة 1

## القاعدة الذهبية

**كل `ledger_entry` مرتبط بـ:**
- `business_id` (المتجر)
- `customer_id` (العميل)

**هذا يعني:**
- كل عميل لديه محفظة مستقلة داخل كل متجر
- لا يوجد رصيد عام - الرصيد خاص بكل متجر على حدة

---

## التفسير المحاسبي

| الحالة | amount | entry_type | المعنى |
|--------|--------|------------|--------|
| + | موجب | `payment` | سداد / رصيد دائن للعميل |
| - | سالب | `debt` | دين على العميل |
| **SUM(amount)** | — | — | **رصيد العميل داخل هذا المتجر فقط** |

### مثال عملي

**العميل أحمد في متجر "سوبر ماركت النور":**
- دفعة: +500 ر.س (payment)
- دين: -200 ر.س (debt)
- **الرصيد = 300 ر.س** (لك)

**العميل أحمد في متجر "مطعم الشام":**
- دفعة: +1000 ر.س (payment)
- دين: -1500 ر.س (debt)
- **الرصيد = -500 ر.س** (عليك)

**النتيجة:** رصيدان منفصلان تماماً.

---

## القيود المعمارية

### ❌ لا جدول `balances`
- الرصيد دائماً `SUM(amount)` من `ledger_entries`
- لا تخزين رصيد في جدول منفصل

### ✅ المصدر الوحيد للحقيقة
- `ledger_entries` table
- `status = 'finalized'` أو `'completed'` فقط

### ✅ Siloed Wallet
- كل `business_id` + `customer_id` = محفظة مستقلة
- لا خلط بين المتاجر

---

## Backend APIs

### `/api/ledger/summary?businessId={id}`
- **الغرض**: حساب الرصيد
- **المنطق**: `SUM(amount) WHERE business_id = X AND customer_id = Y AND status IN ('finalized', 'completed')`
- **النتيجة**: `[{ currency: 'SAR', balance: 300, count: 5 }]`

### `/api/ledger/entries?businessId={id}&limit=50`
- **الغرض**: كشف الحساب الكامل
- **المنطق**: `SELECT * FROM ledger_entries WHERE business_id = X AND customer_id = Y`
- **النتيجة**: قائمة بجميع القيود

---

## Frontend Display

### CustomerWallet.tsx

**العرض:**
- **الرصيد الحالي**: `SUM(amount)` مع العملة
- **الحالة**:
  - رصيد موجب → "لك" (أخضر)
  - رصيد سالب → "عليك" (أحمر)

**Tabs:**
1. **جميع العمليات**: كل `ledger_entries`
2. **المدفوعات**: `entry_type = 'payment'`
3. **الديون**: `entry_type = 'debt'`

**UX:**
- ألوان دلالية واضحة (أخضر/أحمر)
- Labels عربية بسيطة (ليس محاسبية معقدة)
- عرض الحالة (pending/finalized)

---

## التوحيد

### Backend ✅
- `api/ledger/summary.ts` - يستخدم `internalUserId`
- `api/ledger/entries.ts` - يستخدم `internalUserId`
- `api/business/[id].ts` - للحصول على اسم المتجر

### Frontend ✅
- `CustomerWallet.tsx` - مرتبط بالكامل بـ APIs
- عرض واضح للرصيد (لك/عليك)
- Tabs منفصلة للعمليات

---

## الاختبار

### سيناريو 1: عميل جديد
1. العميل يسجل دخول
2. يفتح `/wallet/{storeId}`
3. **النتيجة المتوقعة**: رصيد = 0، لا عمليات

### سيناريو 2: عميل برصيد موجب
1. العميل لديه دفعة +500 ر.س
2. يفتح `/wallet/{storeId}`
3. **النتيجة المتوقعة**: 
   - الرصيد: +500 ر.س (لك) - أخضر
   - Tab "المدفوعات": يظهر دفعة واحدة

### سيناريو 3: عميل برصيد سالب
1. العميل لديه دين -200 ر.س
2. يفتح `/wallet/{storeId}`
3. **النتيجة المتوقعة**:
   - الرصيد: -200 ر.س (عليك) - أحمر
   - Tab "الديون": يظهر دين واحد

### سيناريو 4: عميل في متجرين
1. العميل لديه رصيد +300 في متجر A
2. العميل لديه رصيد -100 في متجر B
3. يفتح `/wallet/{storeIdA}` → يرى +300
4. يفتح `/wallet/{storeIdB}` → يرى -100
5. **النتيجة المتوقعة**: رصيدان منفصلان تماماً

---

**Document Version**: 1.0  
**Last Updated**: 2026-01-20  
**Status**: ✅ Completed
